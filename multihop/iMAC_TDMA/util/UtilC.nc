/*
 * @ author: Xiaohui Liu (whulxh@gmail.com)
 * @ updated: 07/02/2012 
 * @ description: store all active links
 */
#include "Util.h"

module UtilC {
 	provides {
		interface Util;
	}
}

implementation {
//#warning a few links to debug
// neteye
// 19 links: 5 * 5
//link_t activeLinks[] = {{11, 28}, {12, 29}, {13, 14}, {14, 15}, {26, 28}, {28, 13}, {30, 15}, {42, 11}, {43, 44}, {44, 45}, {45, 44}, {56, 28}, {57, 42}, {58, 11}, {60, 45}, {71, 72}, {72, 71}, {73, 44}}; //, {75, 43}}; // deteriorate and become very unreliable
// some links removed to reduce MAX_INCIDENT_LINK_SIZE from 5 to 4
// {75, 43} removed since it is dead after groundtruth measurement
// sparse
//link_t activeLinks[] = {{1, 16}, {2, 47}, {3, 47}, {5, 21}, {7, 23}, {8, 39}, {10, 12}, {11, 28}, {12, 29}, {13, 14}, {14, 15}, {16, 46}, {17, 33}, {18, 17}, {19, 3}, {20, 22}, {21, 7}, {22, 38}, {23, 8}, {24, 23}, {26, 28}, {28, 13}, {29, 10}, {30, 15}, {31, 46}, {32, 17}, {34, 36}, {35, 51}, {36, 22}, {37, 36}, {38, 54}, {39, 8}, {40, 10}, {42, 11}, {43, 44}, {44, 45}, {45, 44}, {46, 32}, {47, 48}, {48, 47}, {49, 124}, {50, 35}, {51, 35}, {52, 51}, {54, 53}, {55, 26}, {56, 28}, {57, 42}, {58, 11}, {60, 45}, {61, 62}, {63, 78}, {65, 66}, {66, 37}, {67, 96}, {68, 83}, {69, 86}, {70, 101}, {71, 72}, {72, 71}, {73, 44}, {76, 62}, {77, 114}, {79, 95}, {80, 82}, {81, 79}, {83, 124}, {84, 101}, {85, 86}, {86, 71}, {87, 101}, {88, 104}, {89, 105}, {90, 89}, {91, 115}, {93, 92}, {94, 96}, {95, 97}, {96, 65}, {97, 95}, {99, 127}, {100, 105}, {101, 89}, {103, 88}, {104, 88}, {105, 103}, {106, 110}, {108, 113}, {110, 111}, {111, 110}, {113, 108}, {115, 91}, {118, 116}, {121, 92}, {122, 125}, {124, 83}, {125, 124}, {127, 125}, {128, 105}};
// collection tree: root is not a source and thus no outgoing link in activeLinks
// long-term reliable links
//SM_SIZE = 67,	//128
//MAX_ACTIVE_LINK_SIZE = 67,	//100,
//MAX_INCIDENT_LINK_SIZE = 5, //4,
//link_t activeLinks[] = {{13, 15}, {28, 13}, {60, 13}};
link_t activeLinks[] = {{1, 47}, {5, 7}, {7, 41}, {9, 28}, {13, 15}, {14, 15}, {16, 46}, {22, 28}, {23, 7}, {28, 13}, {30, 15}, {35, 9}, {38, 28}, {39, 41}, {40, 41}, {41, 14}, {45, 28}, {46, 80}, {47, 48}, {48, 7}, {50, 54}, {53, 9}, {54, 71}, {55, 38}, {57, 58}, {58, 15}, {60, 13}, {62, 48}, {65, 22}, {66, 7}, {67, 39}, {69, 73}, {70, 38}, {71, 14}, {72, 57}, {73, 14}, {75, 60}, {76, 96}, {77, 5}, {79, 35}, {80, 69}, {81, 65}, {84, 54}, {85, 57}, {88, 71}, {89, 60}, {90, 75}, {91, 62}, {94, 48}, {96, 99}, {97, 99}, {99, 57}, {100, 69}, {103, 72}, {104, 60}, {105, 73}, {110, 76}, {111, 77}, {113, 94}, {114, 62}, {116, 48}, {121, 47}, {122, 85},};// {123, 99}, {124, 9}, {125, 69}, {127, 60}};


//#warning kansei: change log format to use UtilsInt16Id!!
//link_t activeLinks[] = {{103, 120}, {104, 105}, {105, 104}, {115, 116}, {121, 103}, {122, 104}, {125, 141}, {132, 115}, {136, 119}, {141, 109}, {142, 125}, {143, 142}, {144, 109}, {145, 142}};
//link_t activeLinks[] = {{103, 135}, {104, 121}, {105, 104}, {106, 121}, {109, 141}, {110, 125}, {115, 116}, {116, 132}, {119, 135}, {120, 170}, {121, 120}, {122, 140}, {125, 141}, {126, 142}, {132, 116}, {133, 134}, {134, 166}, {135, 119}, {136, 152}, {139, 141}, {140, 139}, {142, 126}, {143, 142}, {149, 134}, {150, 103}, {151, 167}, {155, 157}, {158, 157}, {159, 158}, {160, 161}, {161, 210}, {162, 161}, {166, 182}, {167, 183}, {169, 170}, {170, 139}, {179, 196}, {180, 179}, {181, 213}, {182, 166}, {183, 152}, {184, 185}, {195, 180}, {196, 179}, {197, 181}, {198, 182}, {199, 183}, {200, 185}, {207, 224}, {208, 209}, {209, 225}, {213, 214}, {214, 213}, {223, 239}, {224, 207}, {225, 240}, {229, 230}, {230, 229}, {231, 248}, {232, 248}, {233, 250}, {234, 250}, {235, 251}, {236, 252}, {239, 255}, {240, 256}, {241, 240}, {242, 241}, {243, 241}, {244, 259}, {245, 229}, {247, 215}, {248, 232}, {249, 250}, {251, 235}, {252, 235}, {255, 256}, {257, 256}, {258, 210}, {259, 289}, {260, 226}, {262, 278}, {263, 280}, {264, 247}, {267, 268}, {268, 267}, {269, 268}, {270, 269}, {271, 287}, {272, 271}, {274, 273}, {275, 306}, {276, 290}, {277, 246}, {278, 262}, {280, 262}, {283, 267}, {285, 286}, {286, 302}, {287, 271}, {288, 287}, {289, 274}, {290, 306}, {291, 292}, {292, 291}, {293, 261}, {294, 295}, {295, 309}, {297, 313}, {299, 313}, {300, 299}, {301, 302}, {302, 318}, {305, 304}, {306, 290}, {307, 308}, {308, 307}, {309, 310}, {310, 309}, {313, 297}, {315, 332}, {316, 317}, {317, 316}, {320, 321}, {321, 320}, {322, 337}, {323, 292}, {324, 308}, {328, 294}, {329, 299}, {330, 297}, {331, 314}, {332, 315}, {333, 332}, {334, 368}, {335, 304}, {336, 335}, {337, 338}, {338, 337}, {339, 355}, {340, 339}, {343, 360}, {344, 360}, {347, 379}, {348, 365}, {349, 333}, {350, 365}, {352, 368}, {353, 369}, {355, 339}, {357, 358}, {358, 373}, {359, 374}, {360, 343}, {361, 377}, {362, 361}, {364, 365}, {367, 368}, {369, 370}, {370, 369}, {373, 358}, {374, 359}, {375, 359}, {376, 377}, {377, 376}, {378, 379}, {379, 380}, {380, 381}, {381, 380}, {383, 381}, {385, 386}, {389, 390}, {390, 389}, {391, 423}, {392, 390}, {395, 411}, {405, 406}, {406, 405}, {407, 408}, {408, 407}, {411, 427}, {421, 422}, {422, 421}, {423, 407}, {424, 408}, {425, 426}, {426, 425}, {427, 411}, {428, 444}, {437, 422}, {438, 437}, {439, 455}, {440, 456}, {442, 441}, {444, 427}, {455, 440}, {456, 440}, {471, 456}, {472, 471},};
//link_t activeLinks[] = {{103, 135}, {104, 121}, {105, 104}, {106, 121}, {109, 141}, {110, 125}, {115, 116}, {116, 132}, {119, 135}, {120, 170}, {121, 120}, {122, 140}, {125, 141}, {126, 142}, {132, 116}, {133, 134}, {134, 166}, {135, 119}, {136, 152}, {139, 141}, {140, 139}, {141, 157}, {142, 126}, {143, 142}, {144, 116}, {145, 142}, {149, 134}, {150, 103}, {151, 167}, {152, 135}, {155, 157}, {158, 157}, {159, 158}, {160, 161}, {161, 210}, {162, 161}, {166, 182}, {167, 183}, {169, 170}, {170, 139}, {179, 196}, {180, 179}, {181, 213}, {182, 166}, {183, 152}, {184, 185}, {195, 180}, {196, 179}, {197, 181}, {198, 182}, {199, 183}, {200, 185}, {207, 224}, {208, 209}, {209, 225}, {210, 161}, {213, 214}, {214, 213}, {215, 183}, {223, 239}, {224, 207}, {225, 240}, {229, 230}, {230, 229}, {231, 248}, {232, 248}, {233, 250}, {234, 250}, {235, 251}, {236, 252}, {239, 255}, {240, 256}, {241, 240}, {242, 241}, {243, 241}, {244, 259}, {245, 229}, {246, 229}, {247, 215}, {248, 232}, {249, 250}, {250, 235}, {251, 235}, {252, 235}, {255, 256}, {256, 240}, {257, 256}, {258, 210}, {259, 289}, {260, 226}, {261, 248}, {262, 278}, {263, 280}, {264, 247}, {267, 268}, {268, 267}, {269, 268}, {270, 269}, {271, 287}, {272, 271}, {274, 273}, {275, 306}, {276, 290}, {277, 246}, {278, 262}, {280, 262}, {283, 267}, {284, 267}, {285, 286}, {286, 302}, {287, 271}, {288, 287}, {289, 274}, {290, 306}, {291, 292}, {292, 291}, {293, 261}, {294, 295}, {295, 309}, {297, 313}, {299, 313}, {300, 299}, {301, 302}, {302, 318}, {303, 287}, {305, 304}, {306, 290}, {307, 308}, {308, 307}, {309, 310}, {310, 309}, {313, 297}, {314, 313}, {315, 332}, {316, 317}, {317, 316}, {318, 302}, {320, 321}, {321, 320}, {322, 337}, {323, 292}, {324, 308}, {328, 294}, {329, 299}, {330, 297}, {331, 314}, {332, 315}, {333, 332}, {334, 368}, {335, 304}, {336, 335}, {337, 338}, {338, 337}, {339, 355}, {340, 339}, {343, 360}, {344, 360}, {347, 379}, {348, 365}, {349, 333}, {350, 365}, {352, 368}, {353, 369}, {355, 339}, {356, 339}, {357, 358}, {358, 373}, {359, 374}, {360, 343}, {361, 377}, {362, 361}, {364, 365}, {365, 334}, {367, 368}, {368, 334}, {369, 370}, {370, 369}, {373, 358}, {374, 359}, {375, 359}, {376, 377}, {377, 376}, {378, 379}, {379, 380}, {380, 381}, {381, 380}, {382, 380}, {383, 381}, {385, 386}, {386, 369}, {389, 390}, {390, 389}, {391, 423}, {392, 390}, {395, 411}, {396, 379}, {405, 406}, {406, 405}, {407, 408}, {408, 407}, {411, 427}, {421, 422}, {422, 421}, {423, 407}, {424, 408}, {425, 426}, {426, 425}, {427, 411}, {428, 444}, {437, 422}, {438, 437}, {439, 455}, {440, 456}, {441, 422}, {442, 441}, {443, 411}, {444, 427}, {455, 440}, {456, 440}, {471, 456}, {472, 471},};

//#warning Indriya
// power level 3
//link_t activeLinks[] = {{1, 3}, {2, 10}, {3, 1}, {4, 8}, {5, 11}, {8, 4}, {9, 8}, {10, 2}, {11, 1}, {12, 2}, {13, 5}};
//link_t activeLinks[] = {{1, 3}, {2, 10}, {3, 1}, {4, 8}, {5, 11}, {6, 15}, {7, 26}, {8, 4}, {9, 8}, {10, 18}, {11, 5}, {12, 10}, {13, 37}, {14, 17}, {15, 6}, {16, 17}, {17, 16}, {18, 10}, {20, 15}, {21, 11}, {22, 19}, {25, 28}, {26, 7}, {27, 24}, {30, 27}, {36, 26}, {37, 62}, {38, 36}, {39, 38}, {40, 45}, {41, 45}, {42, 45}, {43, 45}, {46, 52}, {47, 56}, {48, 55}, {50, 54}, {52, 41}, {53, 59}, {54, 50}, {55, 48}, {57, 61}, {59, 53}, {60, 62}, {61, 57}, {62, 60}, {63, 71}, {64, 68}, {65, 67}, {66, 68}, {67, 65}, {68, 64}, {69, 78}, {71, 63}, {72, 64}, {73, 79}, {74, 66}, {75, 82}, {76, 66}, {77, 79}, {78, 69}, {79, 77}, {82, 75}, {83, 74}, {84, 77}, {87, 91}, {88, 100}, {89, 90}, {90, 89}, {91, 92}, {92, 91}, {93, 94}, {94, 93}, {96, 109}, {97, 88}, {98, 100}, {99, 108}, {100, 107}, {101, 90}, {102, 103}, {103, 102}, {104, 87}, {105, 106}, {106, 105}, {107, 100}, {109, 97}, {110, 104}, {111, 114}, {113, 104}, {115, 117}, {116, 130}, {117, 118}, {118, 117}, {120, 122}, {122, 120}, {123, 130}, {124, 131}, {125, 135}, {126, 130}, {127, 131}};

// powel level 11
//link_t activeLinks[] = {{1, 2}, {2, 1}, {3, 5}, {4, 1}, {5, 1}, {6, 7}, {7, 3}, {8, 3}, {9, 3}, {10, 5}, {11, 2}, {12, 5}, {13, 16}, {14, 2}, {15, 6}, {16, 10}, {17, 10}, {18, 10}, {19, 11}, {20, 11}, {21, 6}, {22, 13}, {23, 20}, {24, 27}, {25, 28}, {26, 7}, {27, 24}, {28, 25}, {30, 24}, {31, 37}, {32, 30}, {33, 12}, {34, 32}, {35, 12}, {36, 12}, {37, 7}, {38, 6}, {39, 15}, {40, 27}, {41, 27}, {42, 40}, {43, 31}, {44, 41}, {45, 40}, {46, 40}, {47, 42}, {48, 31}, {49, 25}, {50, 24}, {51, 31}, {52, 41}, {53, 25}, {54, 30}, {55, 41}, {56, 42}, {57, 30}, {58, 39}, {59, 28}, {60, 32}, {61, 32}, {62, 33}, {63, 64}, {64, 42}, {65, 63}, {66, 63}, {67, 63}, {68, 43}, {69, 64}, {70, 8}, {71, 64}, {72, 43}, {73, 77}, {74, 66}, {75, 66}, {76, 4}, {77, 73}, {78, 4}, {79, 73}, {80, 15}, {81, 43}, {82, 75}, {83, 4}, {84, 73}, {85, 17}, {86, 11}, {87, 88}, {88, 87}, {89, 87}, {90, 87}, {91, 88}, {92, 88}, {93, 89}, {94, 89}, {95, 91}, {96, 90}, {97, 89}, {98, 90}, {99, 90}, {100, 91}, {101, 91}};

async command link_t *Util.getActiveLinks(uint8_t *size) {
	*size = sizeof(activeLinks) / sizeof(activeLinks[0]);
	return activeLinks;
}

// is the link <sender, receiver> active
async command bool Util.isActiveLink(am_addr_t sender, am_addr_t receiver) {
	uint8_t i;
	
	for (i = 0; i < sizeof(activeLinks) / sizeof(activeLinks[0]); i++) {
		if (activeLinks[i].sender == sender && activeLinks[i].receiver == receiver)
			return TRUE;
	}
	return FALSE;
}

async command uint8_t Util.findLinkIdx(am_addr_t sender, am_addr_t receiver) {
	uint8_t i;
	
	for (i = 0; i < sizeof(activeLinks) / sizeof(activeLinks[0]); i++) {
		if (activeLinks[i].sender == sender && activeLinks[i].receiver == receiver)
			return i;
	}
	return i;
}

// return receiver, at most one for each node
async command am_addr_t Util.getReceiver() {
	uint8_t i;
	
	for (i = 0; i < sizeof(activeLinks) / sizeof(activeLinks[0]); i++) {
		if (activeLinks[i].sender == TOS_NODE_ID)
			return activeLinks[i].receiver;
	}
	return INVALID_ADDR;
}

}
